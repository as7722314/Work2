
@model Work2.Models.Order
@{
    ViewBag.Title = "InsertOrder";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using (Html.BeginForm("InsertOrder", "SelectOrder", FormMethod.Post, new { onsubmit = "return CheckForm()" }))
{
<table>
    <tr>
        <td>@Html.LabelFor(model => model.CustomerID)</td>
        <td>@Html.DropDownListFor(model => model.CustomerID, (List<SelectListItem>)ViewBag.customerlist, "請選擇...")</td>
        <td>@Html.ValidationMessageFor(m => m.CustomerID)</td>
    </tr>
    <tr>
        <td>@Html.LabelFor(model => model.EmployeeID)</td>
        <td>@Html.DropDownListFor(model => model.EmployeeID, (List<SelectListItem>)ViewBag.employeelist, "請選擇...")</td>
        <td>@Html.ValidationMessageFor(m => m.EmployeeID)</td>
    </tr>
    <tr>
        <td>@Html.LabelFor(model => model.OrderDate)</td>
        <td>@Html.TextBoxFor(model => model.OrderDate, new { @type = "date", @class = "form-control" })</td>
        <td>@Html.ValidationMessageFor(m => m.OrderDate)</td>
    </tr>
    <tr>
        <td>@Html.LabelFor(model => model.RequiredDate)</td>
        <td>@Html.TextBoxFor(model => model.RequiredDate, new { @type = "date", @class = "form-control" })</td>
        <td>@Html.ValidationMessageFor(m => m.RequiredDate)</td>
    </tr>
    <tr>
        <td>@Html.LabelFor(model => model.ShipperDate)</td>
        <td>@Html.TextBoxFor(model => model.ShipperDate, new { @type = "date", @class = "form-control" })</td>
    </tr>
    <tr>
        <td>@Html.LabelFor(model => model.ShipperID)</td>
        <td>@Html.DropDownListFor(model => model.ShipperID, (List<SelectListItem>)ViewBag.shipperlist, "請選擇...")</td>
        <td>@Html.ValidationMessageFor(m => m.ShipperID)</td>
    </tr>
    <tr>
        <td>@Html.LabelFor(model => model.ShipName)</td>
        <td>@Html.TextBoxFor(model => model.ShipName, new { @class = "form-control" })</td>
        <td>@Html.ValidationMessageFor(m => m.ShipName)</td>
    </tr>
    <tr>
        <td>@Html.LabelFor(model => model.Freight)</td>
        <td>@Html.TextBoxFor(model => model.Freight, new { type = "number", @class = "form-control" })</td>
        <td>@Html.ValidationMessageFor(m => m.Freight)</td>
    </tr>
    <tr>
        <td>@Html.LabelFor(model => model.ShipCountry)</td>
        <td>@Html.TextBoxFor(model => model.ShipCountry, new { @class = "form-control" })</td>
        <td>@Html.ValidationMessageFor(m => m.ShipCountry)</td>
    </tr>
    <tr>
        <td>@Html.LabelFor(model => model.ShipCity)</td>
        <td>@Html.TextBoxFor(model => model.ShipCity, new { @class = "form-control" })</td>
        <td>@Html.ValidationMessageFor(m => m.ShipCity)</td>
    </tr>
    <tr>
        <td>@Html.LabelFor(model => model.ShipRegion)</td>
        <td>@Html.TextBoxFor(model => model.ShipRegion, new { @class = "form-control" })</td>
    </tr>
    <tr>
        <td>@Html.LabelFor(model => model.CitShipPostalCodey)</td>
        <td>@Html.TextBoxFor(model => model.CitShipPostalCodey, new { @class = "form-control" })</td>
    </tr>
    <tr>
        <td>@Html.LabelFor(model => model.ShipAddress)</td>
        <td>@Html.TextBoxFor(model => model.ShipAddress, new { @class = "form-control" })</td>
        <td>@Html.ValidationMessageFor(m => m.ShipAddress)</td>
    </tr>
</table>
    <input type="submit" value="存檔" />
    <button onclick="location.href='@Url.Action("Index", "SelectOrder")';return false;">回上一頁</button>
    <h3>訂單明細:</h3>
    <table id="detailtable" border="1">
        <tr>
            <th>商品</th>
            <th>單價</th>
            <th>數量</th>
            <th>小計</th>
            <th>動作</th>
        </tr>
    </table>
}
    <button onclick="InsertProduct()" id="InsertProduct">新增商品</button>
    <script type="text/javascript">
        function InsertProduct() {
            $.ajax({
                type : "Get",
                url : "/SelectOrder/InsertProduct",
                datatype : "json",
                success: function (response) {
                    var id = $("#detailtable").find("tr").length-1
                    row = "<tr><td><select id = 'OrderDetail[" + id + "].ProductID' name = 'OrderDetail[" + id + "].ProductID' onchange = 'GetPrice("+id+")'>"
                    for (var i=0;i<response.length;i++){
                        row += "<option value = " + response[i].Value + ">" + response[i].Text + "</option>"
                    }
                    row += "</select></td>"
                    row += "<td> <input type='text' id='OrderDetail[" + id + "].UnitPrice' name = 'OrderDetail[" + id + "].UnitPrice' onchange= GetTotal(" + id +") ></td> " +
                        "<td> <input type='text' id='OrderDetail[" + id + "].Qty' name = 'OrderDetail[" + id + "].Qty' onchange= GetTotal("+id+") ></td> " +
                        "<td> <input type='text' id='Sum" + id + "' name = 'Sum" + id + "' </td>"+
                        "<td><input type = 'button' onclick = 'DelRow(this)' value = '刪除'></td></tr> "
                        
                    $("#detailtable").append(row);
                },              
                error: function (error) {
                    alert("新增欄位失敗");
                }
            });
        };
        
        function GetPrice(id) {
            var key = $("select[id = 'OrderDetail[" + id + "].ProductID']").val();

            $.ajax({
                type : "Get",
                url : "/SelectOrder/GetPrice?arg=" + key ,
                datatype : "json",
                success: function (response) {
                    $("input[id = 'OrderDetail[" + id + "].UnitPrice']").val(response);
                },
                error: function (error) {
                    console.log("error");
                }
            });
        };
        function GetTotal(id) {
            var money = $("input[id = 'OrderDetail[" + id + "].UnitPrice']").val() * $("input[id = 'OrderDetail[" + id + "].Qty']").val();
            $("#Sum" + id).val(money);                  
        };
        function DelRow(row) {
            $(row).parent().parent().remove(); //移除选中的行  
            if (($("#detailtable").find("tr").length - 1) >= 1) {
                for (var a = 0; a < $("#detailtable").find("tr").length - 1; a++) {
                    $('table select')[a + 3].id = "OrderDetail[" + a + "].ProductID";
                    $('table select')[a + 3].name = "OrderDetail[" + a + "].ProductID";
                    $("select[id='OrderDetail[" + a + "].ProductID']").attr("onchange", "GetPrice(" + a + ")")
                }
                var c = $("#detailtable").find("tr").length - 2;
                for (var b = $('table input').length - 2; b >= 9; b = b - 4) {
                    $('table input')[b].id = "Sum" + c;
                    $('table input')[b - 1].id = "OrderDetail[" + c + "].Qty";
                    $('table input')[b - 1].name = "OrderDetail[" + c + "].Qty";
                    $('table input')[b - 2].id = "OrderDetail[" + c + "].UnitPrice";
                    $('table input')[b - 2].name = "OrderDetail[" + c + "].UnitPrice";
                    $("input[id='OrderDetails[" + c + "].Qty']").attr("onchange", "GetTotal(" + c + ")")
                    $("input[id='OrderDetails[" + c + "].UnitPrice']").attr("onchange", "GetTotal(" + c + ")")
                    c = c - 1;
                }
            }
        };
        function CheckForm() {
            var tr = $("#detailtable").find("tr").length;
            var form = true;
            var p = 0, q = 0; 
            if (tr > 1) {                
                for (var j = 0; j < tr; j++) {                                       
                    if ($("input[id = 'OrderDetail[" + j + "].UnitPrice']").val() == "") {
                        p += 1;
                    }                        
                    if ($("input[id = 'OrderDetail[" + j + "].Qty']").val() == "") {
                        q += 1;                           
                    }
                    if (p == 1 && q == 1) {
                        form = false;
                        alert("沒輸入單價和數量");
                        return form;
                    } else if (p == 1) {
                        form = false;
                        alert("單價未輸入");
                        return form;
                    } else if (q == 1){
                        form = false;
                        alert("數量未輸入");
                        return form;
                    }
                }
                for (var a = 0; a < tr; a++) {
                    for (var b = 0; b < tr; b++) {
                        if (a != b) {                            
                            if ($("select[id = 'OrderDetail[" + a + "].ProductID']").val() == $("select[id = 'OrderDetail[" + b + "].ProductID']").val()) {                                
                                form = false;
                                alert("商品重複");
                                return form;
                            }
                        }                        
                    }                    
                }
            } else {
                form = false;
                alert("請新增商品");
                return form;
            }

        };

    </script>

